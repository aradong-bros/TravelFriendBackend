<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="train_task">
	<select id="selectStationNo" parameterType="string" resultType="int">
		<![CDATA[
		select no from trainStation
		where `name` = #{stationName}
		]]>
	</select>
	
	<select id="selectStationName" parameterType="int" resultType="string">
		<![CDATA[
		select name from trainStation where no = #{trainStation_no}
		]]>
	</select>
	
	<select id="selectStartTrainTime" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select start.* from 
			(select * from trainOperationRoute where trainStation_no = #{startStationNo}) start,
			(select * from trainOperationRoute where trainStation_no = #{endStationNo}) end
		where start.trainInfo_no = end.trainInfo_no 
			and start.order < end.order 
			and start.trainCategory_no = #{categoryNo} 
			and start.trainCategory_no = end.trainCategory_no
		order by start.departureTime asc;
		]]>
	</select>
	
	<select id="selectEndTrainTime" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select end.* from 
			(select * from trainOperationRoute where trainStation_no = #{startStationNo}) start,
			(select * from trainOperationRoute where trainStation_no = #{endStationNo}) end
		where start.trainInfo_no = end.trainInfo_no 
			and start.order < end.order 
			and start.trainCategory_no = #{categoryNo} 
			and start.trainCategory_no = end.trainCategory_no
		order by start.departureTime asc;
		]]>
	</select>
	
	<select id="selectStartFastAndEarlyTrainTime" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select start.* from 
			(select * from trainOperationRoute where trainStation_no = #{startStationNo}) start,
			(select * from trainOperationRoute where trainStation_no = #{endStationNo}) end
		where start.trainInfo_no = end.trainInfo_no 
			and start.order < end.order 
			and start.trainCategory_no = #{categoryNo}
			and start.trainCategory_no = end.trainCategory_no
		order by ( if( end.departureTime<start.departureTime, ((hour(end.departureTime)+24)*60+minute(end.departureTime)), (hour(end.departureTime)*60+minute(end.departureTime)) ) - (hour(start.departureTime)*60+minute(start.departureTime)) )
		limit 0,5;
		]]>
	</select>
	
	<select id="selectEndFastAndEarlyTrainTime" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select end.* from 
			(select * from trainOperationRoute where trainStation_no = #{startStationNo}) start,
			(select * from trainOperationRoute where trainStation_no = #{endStationNo}) end
		where start.trainInfo_no = end.trainInfo_no 
			and start.order < end.order 
			and start.trainCategory_no = #{categoryNo}
			and start.trainCategory_no = end.trainCategory_no
		order by ( if( end.departureTime<start.departureTime, ((hour(end.departureTime)+24)*60+minute(end.departureTime)), (hour(end.departureTime)*60+minute(end.departureTime)) ) - (hour(start.departureTime)*60+minute(start.departureTime)) )
		limit 0,5;
		]]>
	</select>
	
	<select id="selectTrainStationByCityNo" parameterType="int" resultType="trainstationvo">
		<![CDATA[
		select * from
			trainStation
		where cityNum = #{cityNum}
		]]>
	</select>
	
	<select id="selectTransferStationList" parameterType="int" resultType="int">
		<![CDATA[
		select start.trainStation_no from
			(select route.* from
				trainOperationRoute route,
				(select trainInfo_no from trainOperationRoute where trainStation_no = #{startStationNo}) train
			where route.trainInfo_no = train.trainInfo_no) start,
			(select route.* from
				trainOperationRoute route,
				(select trainInfo_no from trainOperationRoute where trainStation_no = #{endStationNo}) train
			where route.trainInfo_no = train.trainInfo_no) end
		where start.trainStation_no = end.trainStation_no
		group by start.trainStation_no;
		]]>
	</select>
	
	<select id="selectStartTrainTimeAfter" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select start.* from
			(select * from trainOperationRoute where trainStation_no = #{startStationNo}) start,
			(select * from trainOperationRoute where trainStation_no = #{transferStationNo}) transfer
		where start.trainInfo_no = transfer.trainInfo_no
			and start.order < transfer.order
			and start.trainCategory_no = #{categoryNo} 
			and start.trainCategory_no = transfer.trainCategory_no
			and start.departureTime > #{boardingTime}
		]]>
	</select>
	
	<select id="selectTransferEndTrainTime" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select transfer.* from
			(select * from trainOperationRoute where trainStation_no = #{startStationNo}) start,
			(select * from trainOperationRoute where trainStation_no = #{transferStationNo}) transfer
		where start.trainInfo_no = transfer.trainInfo_no
			and start.order < transfer.order
			and start.trainCategory_no = #{categoryNo} 
			and start.trainCategory_no = transfer.trainCategory_no
			and start.departureTime > #{boardingTime}
		]]>
	</select>
	
	<select id="selectTransferStartTrainTime" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select transfer.* from
			(select * from trainOperationRoute where trainStation_no = #{transferStationNo}) transfer,
			(select * from trainOperationRoute where trainStation_no = #{endStationNo}) end
		where transfer.trainInfo_no = end.trainInfo_no
			and transfer.order < end.order
			and transfer.trainCategory_no = #{categoryNo}
			and transfer.trainCategory_no = end.trainCategory_no
			and transfer.departureTime >= addTime(#{boardingTime}, "00:10") and transfer.departureTime < addTime(#{boardingTime}, "00:50")
		order by transfer.departureTime asc
		]]>
	</select>
	
	<select id="selectEndTrainTimeAfter" parameterType="map" resultType="trainoperationroutevo">
		<![CDATA[
		select end.* from
			(select * from trainOperationRoute where trainStation_no = #{transferStationNo}) transfer,
			(select * from trainOperationRoute where trainStation_no = #{endStationNo}) end
		where transfer.trainInfo_no = end.trainInfo_no
			and transfer.order < end.order
			and transfer.trainCategory_no = #{categoryNo}
			and transfer.trainCategory_no = end.trainCategory_no
			and transfer.departureTime >= addTime(#{boardingTime}, "00:10") and transfer.departureTime < addTime(#{boardingTime}, "00:50")
		order by transfer.departureTime asc
		]]>
	</select>
</mapper>